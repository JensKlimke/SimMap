<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulation output</title>

    <style>

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        .agent-box {
            fill: transparent;
            stroke: #aa3500;
            stroke-width: 1px;
        }

        polyline {
            stroke-width: 1;
            stroke: black;
        }

    </style>

</head>

<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
    <div id="sim-canvas"></div>

    <script type="application/javascript">

        var map = false;
        var svg = false;
        var width  = 1000;

        var plotMap = function() {

            // check if time info is available and update time
            if(map !== false) {

                if(!svg) {

                    const y1 = map.meta.yMax;
                    const y0 = map.meta.yMin;
                    const x1 = map.meta.xMax;
                    const x0 = map.meta.xMin;

                    console.log(x0 + " " + x1 + " " + y0 + " " + y1);

                    var ratio  = (y1 - y0) / (x1 - x0);
                    var height = width * ratio;

                    svg = {};
                    svg.container = d3.select("#sim-canvas")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

                    svg.x_scale = d3.scale.linear()
                        .domain([x0, x1])
                        .range([40, width - 20]);

                    svg.y_scale = d3.scale.linear()
                        .domain([y0, y1])
                        .range([height - 20, 40]);

                    svg.x_axis = d3.svg.axis()
                        .scale(svg.x_scale)
                        .orient("bottom");

                    svg.y_axis = d3.svg.axis()
                        .scale(svg.y_scale)
                        .orient("left");

                    svg.container.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + (height - 20) + ")")
                        .call(svg.x_axis);

                    svg.container.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(40,0)")
                        .call(svg.y_axis);

                }

                svg.maplines = svg.container
                    .selectAll("polyline")
                    .data(map.data);

                svg.maplines
                    .exit()
                    .remove();

                svg.maplines
                    .enter()
                    .append("polyline")
                    .attr("fill", "none")
                    .attr("stroke-dasharray", (d) => {

                        return d.type === "ref" ? "4 3 1 3" : "1";

                    })
                    .attr("points", (d) => {

                        var p = "";
                        for(let i = 0; i < d.points.length; ++i)
                            p += "\n" + svg.x_scale(d.points[i].x) + "," + svg.y_scale(d.points[i].y);

                        return p;

                    });

            } else {

                svg = false;
                $("#sim-canvas").empty();

            }

        };

        $.ajax({
            dataType: "json",
            url: '../../tests/tracks/map.json',
            data: '',
            cache : false,
            success: (res, err) => {

                console.log(err);

                if(err === "success") {
                    map = res;
                    plotMap();
                }

            },
            error: (res) => {
                console.log(res);
            }
        });

    </script>

</body>
</html>